<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>롱레이크 생태계 시뮬레이션</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .control-panel {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            background: #3498db;
            color: white;
            font-weight: bold;
        }
        
        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .danger-btn {
            background: #e74c3c;
        }
        
        .danger-btn:hover {
            background: #c0392b;
        }
        
        .success-btn {
            background: #27ae60;
        }
        
        .success-btn:hover {
            background: #229954;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .simulation-area {
            background: #ecf0f1;
            border-radius: 5px;
            padding: 10px;
        }
        
        canvas {
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            width: 100%;
            height: auto;
            background: rgba(200, 230, 250, 0.3);
        }
        
        .info-panel {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
        }
        
        .monitor {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .monitor-label {
            font-weight: bold;
            color: #34495e;
        }
        
        .monitor-value {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .zoo-value { color: #3498db; }
        .fish-value { color: #f39c12; }
        .bass-value { color: #e74c3c; }
        .phyto-value { color: #27ae60; }
        
        .phase-monitor {
            background: linear-gradient(135deg, #667eea20, #764ba220);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .speed-slider {
            flex: 1;
        }
        
        .graph-container {
            background: white;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 10px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐟 롱레이크 생태계 시뮬레이션</h1>
        
        <div class="control-panel">
            <button onclick="setup()" class="success-btn">초기 설정</button>
            <button onclick="toggleGo()">실행/정지</button>
            <button onclick="removeAllBass()" class="danger-btn">배스 전체 제거</button>
            <button onclick="addBass(5)">배스 5마리 추가</button>
            <button onclick="addFish(10)">물고기 10마리 추가</button>
            <button onclick="resetGraph()">그래프 초기화</button>
        </div>
        
        <div class="main-grid">
            <div class="simulation-area">
                <canvas id="worldCanvas" width="600" height="400"></canvas>
                <div class="speed-control">
                    <label>속도:</label>
                    <input type="range" class="speed-slider" min="1" max="100" value="50" id="speedSlider">
                    <span id="speedValue">50</span>
                </div>
                <canvas id="graphCanvas" width="600" height="200"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span>동물플랑크톤</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f39c12;"></div>
                        <span>작은물고기</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span>배스</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #27ae60;"></div>
                        <span>식물플랑크톤</span>
                    </div>
                </div>
            </div>
            
            <div class="info-panel">
                <div class="phase-monitor" id="phaseMonitor">평형 상태</div>
                
                <div class="monitor">
                    <span class="monitor-label">동물플랑크톤</span>
                    <span class="monitor-value zoo-value" id="zooCount">0</span>
                </div>
                
                <div class="monitor">
                    <span class="monitor-label">작은 물고기</span>
                    <span class="monitor-value fish-value" id="fishCount">0</span>
                </div>
                
                <div class="monitor">
                    <span class="monitor-label">배스</span>
                    <span class="monitor-value bass-value" id="bassCount">0</span>
                </div>
                
                <div class="monitor">
                    <span class="monitor-label">식물플랑크톤</span>
                    <span class="monitor-value phyto-value" id="phytoCount">0</span>
                </div>
                
                <h3 style="margin-top: 20px; color: #2c3e50;">시뮬레이션 설명</h3>
                <p style="margin-top: 10px; color: #555; line-height: 1.6;">
                    이 시뮬레이션은 미시간주 롱레이크의 영양단계 연쇄를 보여줍니다.
                    배스를 제거하면 작은물고기가 폭증하고, 
                    이는 동물플랑크톤 감소와 식물플랑크톤 폭발(녹조)로 이어집니다.
                </p>
            </div>
        </div>
    </div>
    
    <script>
        // 캔버스 설정
        const worldCanvas = document.getElementById('worldCanvas');
        const worldCtx = worldCanvas.getContext('2d');
        const graphCanvas = document.getElementById('graphCanvas');
        const graphCtx = graphCanvas.getContext('2d');
        
        // 전역 변수
        let isRunning = false;
        let ticks = 0;
        let speed = 50;
        let animationId = null;
        let initialBassCount = 0;
        
        // 개체 배열
        let zooplankton = [];
        let smallFish = [];
        let bass = [];
        let patches = [];
        
        // 그래프 데이터
        let history = {
            zoo: [],
            fish: [],
            bass: [],
            phyto: []
        };
        
        // 패치 클래스 (식물플랑크톤)
        class Patch {
            constructor(x, y, size) {
                this.x = x;
                this.y = y;
                this.size = size;
                this.phytoplankton = 5;
            }
            
            update() {
                // 식물플랑크톤 재생
                this.phytoplankton += 0.05;
                if (this.phytoplankton > 10) this.phytoplankton = 10;
            }
            
            draw() {
                const intensity = this.phytoplankton / 10;
                const greenValue = Math.floor(100 + intensity * 100);
                worldCtx.fillStyle = `rgba(0, ${greenValue}, 50, 0.3)`;
                worldCtx.fillRect(this.x, this.y, this.size, this.size);
            }
        }
        
        // 동물플랑크톤 클래스
        class Zooplankton {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.energy = 10;
                this.age = 0;
                this.angle = Math.random() * Math.PI * 2;
            }
            
            update() {
                // 식물플랑크톤이 많은 곳으로 이동
                const patchSize = 20;
                const px = Math.floor(this.x / patchSize);
                const py = Math.floor(this.y / patchSize);
                
                if (patches[py] && patches[py][px]) {
                    const currentPatch = patches[py][px];
                    
                    // 식물플랑크톤 섭취
                    if (currentPatch.phytoplankton > 0) {
                        const eaten = Math.min(0.1, currentPatch.phytoplankton);
                        currentPatch.phytoplankton -= eaten;
                        this.energy += eaten * 20;
                    }
                }
                
                // 이동
                this.angle += (Math.random() - 0.5) * 0.5;
                this.x += Math.cos(this.angle) * 0.3;
                this.y += Math.sin(this.angle) * 0.3;
                
                // 경계 처리
                if (this.x < 0) this.x = worldCanvas.width;
                if (this.x > worldCanvas.width) this.x = 0;
                if (this.y < 0) this.y = worldCanvas.height;
                if (this.y > worldCanvas.height) this.y = 0;
                
                // 대사
                this.energy -= 0.1;
                this.age++;
                
                // 번식
                if (this.energy > 15 && Math.random() < 0.05) {
                    zooplankton.push(new Zooplankton(this.x + Math.random() * 10 - 5, this.y + Math.random() * 10 - 5));
                    this.energy -= 5;
                }
            }
            
            draw() {
                worldCtx.fillStyle = 'rgba(52, 152, 219, 0.8)';
                worldCtx.beginPath();
                worldCtx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                worldCtx.fill();
            }
            
            isDead() {
                return this.energy <= 0 || this.age > 300;
            }
        }
        
        // 작은물고기 클래스
        class SmallFish {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.energy = 20;
                this.age = 0;
                this.angle = Math.random() * Math.PI * 2;
            }
            
            update() {
                // 가장 가까운 동물플랑크톤 찾기
                if (this.energy < 15 && zooplankton.length > 0) {
                    let nearest = null;
                    let minDist = Infinity;
                    
                    for (let zoo of zooplankton) {
                        const dist = Math.hypot(zoo.x - this.x, zoo.y - this.y);
                        if (dist < minDist && dist < 50) {
                            minDist = dist;
                            nearest = zoo;
                        }
                    }
                    
                    if (nearest) {
                        this.angle = Math.atan2(nearest.y - this.y, nearest.x - this.x);
                        
                        // 포식
                        if (minDist < 5) {
                            const index = zooplankton.indexOf(nearest);
                            if (index > -1) {
                                zooplankton.splice(index, 1);
                                this.energy += 5;
                            }
                        }
                    }
                }
                
                // 이동
                this.x += Math.cos(this.angle) * 0.5;
                this.y += Math.sin(this.angle) * 0.5;
                this.angle += (Math.random() - 0.5) * 0.3;
                
                // 경계 처리
                if (this.x < 0) this.x = worldCanvas.width;
                if (this.x > worldCanvas.width) this.x = 0;
                if (this.y < 0) this.y = worldCanvas.height;
                if (this.y > worldCanvas.height) this.y = 0;
                
                // 대사
                this.energy -= 0.15;
                this.age++;
                
                // 번식
                if (this.energy > 25 && Math.random() < 0.03) {
                    smallFish.push(new SmallFish(this.x + Math.random() * 20 - 10, this.y + Math.random() * 20 - 10));
                    this.energy -= 10;
                }
            }
            
            draw() {
                worldCtx.save();
                worldCtx.translate(this.x, this.y);
                worldCtx.rotate(this.angle);
                
                // 물고기 몸체
                worldCtx.fillStyle = 'rgba(243, 156, 18, 0.9)';
                worldCtx.beginPath();
                worldCtx.ellipse(0, 0, 6, 3, 0, 0, Math.PI * 2);
                worldCtx.fill();
                
                // 꼬리
                worldCtx.beginPath();
                worldCtx.moveTo(-6, 0);
                worldCtx.lineTo(-10, -3);
                worldCtx.lineTo(-10, 3);
                worldCtx.closePath();
                worldCtx.fill();
                
                worldCtx.restore();
            }
            
            isDead() {
                return this.energy <= 0 || this.age > 400;
            }
        }
        
        // 배스 클래스
        class Bass {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.energy = 30;
                this.age = 0;
                this.angle = Math.random() * Math.PI * 2;
            }
            
            update() {
                // 가장 가까운 작은물고기 찾기
                if (this.energy < 20 && smallFish.length > 0) {
                    let nearest = null;
                    let minDist = Infinity;
                    
                    for (let fish of smallFish) {
                        const dist = Math.hypot(fish.x - this.x, fish.y - this.y);
                        if (dist < minDist && dist < 60) {
                            minDist = dist;
                            nearest = fish;
                        }
                    }
                    
                    if (nearest) {
                        this.angle = Math.atan2(nearest.y - this.y, nearest.x - this.x);
                        
                        // 포식
                        if (minDist < 8) {
                            const index = smallFish.indexOf(nearest);
                            if (index > -1) {
                                smallFish.splice(index, 1);
                                this.energy += 10;
                            }
                        }
                    }
                }
                
                // 이동
                this.x += Math.cos(this.angle) * 0.4;
                this.y += Math.sin(this.angle) * 0.4;
                this.angle += (Math.random() - 0.5) * 0.2;
                
                // 경계 처리
                if (this.x < 0) this.x = worldCanvas.width;
                if (this.x > worldCanvas.width) this.x = 0;
                if (this.y < 0) this.y = worldCanvas.height;
                if (this.y > worldCanvas.height) this.y = 0;
                
                // 대사
                this.energy -= 0.2;
                this.age++;
                
                // 번식
                if (this.energy > 35 && Math.random() < 0.02) {
                    bass.push(new Bass(this.x + Math.random() * 30 - 15, this.y + Math.random() * 30 - 15));
                    this.energy -= 15;
                }
            }
            
            draw() {
                worldCtx.save();
                worldCtx.translate(this.x, this.y);
                worldCtx.rotate(this.angle);
                
                // 배스 몸체
                worldCtx.fillStyle = 'rgba(231, 76, 60, 1)';
                worldCtx.beginPath();
                worldCtx.ellipse(0, 0, 10, 5, 0, 0, Math.PI * 2);
                worldCtx.fill();
                
                // 꼬리
                worldCtx.beginPath();
                worldCtx.moveTo(-10, 0);
                worldCtx.lineTo(-15, -5);
                worldCtx.lineTo(-15, 5);
                worldCtx.closePath();
                worldCtx.fill();
                
                worldCtx.restore();
            }
            
            isDead() {
                return this.energy <= 0 || this.age > 500;
            }
        }
        
        // 초기 설정
        function setup() {
            // 초기화
            zooplankton = [];
            smallFish = [];
            bass = [];
            patches = [];
            history = { zoo: [], fish: [], bass: [], phyto: [] };
            ticks = 0;
            
            // 패치 생성 (식물플랑크톤 환경)
            const patchSize = 20;
            for (let y = 0; y < worldCanvas.height / patchSize; y++) {
                patches[y] = [];
                for (let x = 0; x < worldCanvas.width / patchSize; x++) {
                    patches[y][x] = new Patch(x * patchSize, y * patchSize, patchSize);
                }
            }
            
            // 동물플랑크톤 생성
            for (let i = 0; i < 100; i++) {
                zooplankton.push(new Zooplankton(
                    Math.random() * worldCanvas.width,
                    Math.random() * worldCanvas.height
                ));
            }
            
            // 작은물고기 생성
            for (let i = 0; i < 30; i++) {
                smallFish.push(new SmallFish(
                    Math.random() * worldCanvas.width,
                    Math.random() * worldCanvas.height
                ));
            }
            
            // 배스 생성
            for (let i = 0; i < 8; i++) {
                bass.push(new Bass(
                    Math.random() * worldCanvas.width,
                    Math.random() * worldCanvas.height
                ));
            }
            
            initialBassCount = bass.length;
            updateMonitors();
        }
        
        // 실행/정지
        function toggleGo() {
            isRunning = !isRunning;
            if (isRunning) {
                go();
            }
        }
        
        // 메인 루프
        function go() {
            if (!isRunning) return;
            
            // 패치 업데이트
            for (let row of patches) {
                for (let patch of row) {
                    patch.update();
                }
            }
            
            // 죽은 개체 제거
            zooplankton = zooplankton.filter(z => !z.isDead());
            smallFish = smallFish.filter(f => !f.isDead());
            bass = bass.filter(b => !b.isDead());
            
            // 개체 업데이트
            zooplankton.forEach(z => z.update());
            smallFish.forEach(f => f.update());
            bass.forEach(b => b.update());
            
            // 그리기
            draw();
            
            // 모니터 업데이트
            if (ticks % 10 === 0) {
                updateMonitors();
                updateGraph();
            }
            
            ticks++;
            
            // 다음 프레임
            setTimeout(() => go(), 1000 / speed);
        }
        
        // 그리기
        function draw() {
            worldCtx.clearRect(0, 0, worldCanvas.width, worldCanvas.height);
            
            // 패치 그리기
            for (let row of patches) {
                for (let patch of row) {
                    patch.draw();
                }
            }
            
            // 개체 그리기
            zooplankton.forEach(z => z.draw());
            smallFish.forEach(f => f.draw());
            bass.forEach(b => b.draw());
        }
        
        // 모니터 업데이트
        function updateMonitors() {
            document.getElementById('zooCount').textContent = zooplankton.length;
            document.getElementById('fishCount').textContent = smallFish.length;
            document.getElementById('bassCount').textContent = bass.length;
            
            let phytoTotal = 0;
            for (let row of patches) {
                for (let patch of row) {
                    phytoTotal += patch.phytoplankton;
                }
            }
            document.getElementById('phytoCount').textContent = Math.round(phytoTotal);
            
            // 생태계 단계 업데이트
            updatePhase();
        }
        
        // 생태계 단계 판단
        function updatePhase() {
            const bassRatio = initialBassCount > 0 ? bass.length / initialBassCount : 0;
            const fishCount = smallFish.length;
            const zooCount = zooplankton.length;
            
            let phase = "평형 상태";
            
            if (bassRatio === 0 && fishCount > 60) {
                phase = "작은물고기 폭증!";
            } else if (bassRatio === 0 && zooCount < 30) {
                phase = "동물플랑크톤 고갈!";
            } else if (bassRatio === 0 && fishCount > 100) {
                phase = "녹조 대발생!";
            } else if (bassRatio < 0.5 && bassRatio > 0) {
                phase = "배스 감소 중";
            }
            
            document.getElementById('phaseMonitor').textContent = phase;
        }
        
        // 그래프 업데이트
        function updateGraph() {
            // 데이터 추가
            history.zoo.push(zooplankton.length);
            history.fish.push(smallFish.length);
            history.bass.push(bass.length);
            
            let phytoTotal = 0;
            for (let row of patches) {
                for (let patch of row) {
                    phytoTotal += patch.phytoplankton;
                }
            }
            history.phyto.push(phytoTotal / 10);
            
            // 데이터 제한
            const maxPoints = 200;
            if (history.zoo.length > maxPoints) {
                history.zoo.shift();
                history.fish.shift();
                history.bass.shift();
                history.phyto.shift();
            }
            
            // 그래프 그리기
            graphCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
            
            // 축
            graphCtx.strokeStyle = '#34495e';
            graphCtx.lineWidth = 2;
            graphCtx.beginPath();
            graphCtx.moveTo(30, 10);
            graphCtx.lineTo(30, 170);
            graphCtx.lineTo(580, 170);
            graphCtx.stroke();
            
            // 데이터 선
            const colors = {
                zoo: '#3498db',
                fish: '#f39c12',
                bass: '#e74c3c',
                phyto: '#27ae60'
            };
            
            Object.keys(history).forEach(key => {
                graphCtx.strokeStyle = colors[key];
                graphCtx.lineWidth = 2;
                graphCtx.beginPath();
                
                history[key].forEach((value, index) => {
                    const x = 30 + (index / maxPoints) * 550;
                    const y = 170 - (value / 200) * 150;
                    
                    if (index === 0) {
                        graphCtx.moveTo(x, y);
                    } else {
                        graphCtx.lineTo(x, y);
                    }
                });
                
                graphCtx.stroke();
            });
        }
        
        // 배스 제거
        function removeAllBass() {
            bass = [];
            updateMonitors();
        }
        
        // 배스 추가
        function addBass(n) {
            for (let i = 0; i < n; i++) {
                bass.push(new Bass(
                    Math.random() * worldCanvas.width,
                    Math.random() * worldCanvas.height
                ));
            }
            updateMonitors();
        }
        
        // 물고기 추가
        function addFish(n) {
            for (let i = 0; i < n; i++) {
                smallFish.push(new SmallFish(
                    Math.random() * worldCanvas.width,
                    Math.random() * worldCanvas.height
                ));
            }
            updateMonitors();
        }
        
        // 그래프 초기화
        function resetGraph() {
            history = { zoo: [], fish: [], bass: [], phyto: [] };
        }
        
        // 속도 조절
        document.getElementById('speedSlider').addEventListener('input', function(e) {
            speed = parseInt(e.target.value);
            document.getElementById('speedValue').textContent = speed;
        });
        
        // 초기 실행
        setup();
    </script>
</body>
</html>
